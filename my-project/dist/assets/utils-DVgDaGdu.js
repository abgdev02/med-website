var v=Object.defineProperty;var z=(c,t,e)=>t in c?v(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var a=(c,t,e)=>z(c,typeof t!="symbol"?t+"":t,e);import{F as k,i as F,j as p,c as P}from"./three-TqPnz05j.js";class I{constructor(t){a(this,"cache",new Map);a(this,"maxSize");this.maxSize=t}get(t){const e=this.cache.get(t);return e!==void 0&&(this.cache.delete(t),this.cache.set(t,e)),e}set(t,e){if(this.cache.has(t))this.cache.delete(t);else if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;s!==void 0&&this.cache.delete(s)}this.cache.set(t,e)}has(t){return this.cache.has(t)}delete(t){return this.cache.delete(t)}clear(){this.cache.clear()}size(){return this.cache.size}keys(){return this.cache.keys()}values(){return this.cache.values()}}class w{constructor(){a(this,"tasks",[]);a(this,"frameTime",16.67);a(this,"maxFrameBudget",.8);a(this,"isRunning",!1);a(this,"lastFrameTime",0)}addTask(t){const e={...t,lastUpdate:performance.now(),enabled:!0};this.tasks.push(e),this.sortByPriority()}removeTask(t){this.tasks=this.tasks.filter(e=>e.id!==t)}enableTask(t){const e=this.tasks.find(s=>s.id===t);e&&(e.enabled=!0)}disableTask(t){const e=this.tasks.find(s=>s.id===t);e&&(e.enabled=!1)}update(t){if(!this.isRunning)return;const e=performance.now(),s=this.frameTime*this.maxFrameBudget,i=e;for(const r of this.tasks){if(e-i>s)break;if(r.enabled&&e-r.lastUpdate>=r.updateInterval)try{r.callback(t),r.lastUpdate=e}catch(o){console.warn(`Animation task ${r.id} failed:`,o)}}this.lastFrameTime=e}updatePriority(t,e){const s=this.tasks.find(i=>i.id===t);s&&(s.priority=e,this.sortByPriority())}updateInterval(t,e){const s=this.tasks.find(i=>i.id===t);s&&(s.updateInterval=e)}start(){this.isRunning=!0}stop(){this.isRunning=!1}clear(){this.tasks=[]}getTaskCount(){return this.tasks.filter(t=>t.enabled).length}getFrameStats(){const e=performance.now()-this.lastFrameTime,s=this.frameTime*this.maxFrameBudget;return{budget:s,usage:e,efficiency:s>0?(s-e)/s:1}}sortByPriority(){this.tasks.sort((t,e)=>e.priority-t.priority)}}const T=new w;T.start();class O{constructor(){a(this,"frustum",new k);a(this,"cameraMatrix",new F);a(this,"objects",new Map)}addObject(t,e,s){let i;s?i=s.clone():i=new p().setFromObject(e),this.objects.set(t,{object:e,bounds:i})}removeObject(t){this.objects.delete(t)}updateCamera(t){this.cameraMatrix.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this.frustum.setFromProjectionMatrix(this.cameraMatrix)}cullObjects(){const t=[],e=[];for(const[s,{object:i,bounds:r}]of this.objects.entries()){const o=r.clone();o.applyMatrix4(i.matrixWorld),this.frustum.intersectsBox(o)?(t.push({id:s,object:i}),i.visible=!0):(e.push({id:s,object:i}),i.visible=!1)}return{visible:t,hidden:e}}isVisible(t){const e=this.objects.get(t);if(!e)return!1;const s=e.bounds.clone();return s.applyMatrix4(e.object.matrixWorld),this.frustum.intersectsBox(s)}getVisibleObjects(){const t=[];for(const[e,{object:s,bounds:i}]of this.objects.entries()){const r=i.clone();r.applyMatrix4(s.matrixWorld),this.frustum.intersectsBox(r)&&t.push({id:e,object:s})}return t}updateObjectBounds(t,e){const s=this.objects.get(t);s&&(e?s.bounds=e.clone():s.bounds=new p().setFromObject(s.object))}clear(){this.objects.clear()}getStats(){const t=this.objects.size,{visible:e,hidden:s}=this.cullObjects(),i=e.length,r=s.length,o=t>0?r/t:0;return{totalObjects:t,visibleCount:i,hiddenCount:r,cullingEfficiency:o}}}class A{constructor(t){a(this,"cellSize");a(this,"grid",new Map);a(this,"objects",new Map);this.cellSize=t}hash(t,e,s){const i=Math.floor(t/this.cellSize),r=Math.floor(e/this.cellSize),o=Math.floor(s/this.cellSize);return`${i},${r},${o}`}insert(t,e,s,i){this.remove(t);let r,o,n;typeof e=="number"?(r=e,o=s,n=i):(r=e.x,o=e.y,n=e.z);const h=this.hash(r,o,n);this.grid.has(h)||this.grid.set(h,new Set),this.grid.get(h).add(t),this.objects.set(t,new P(r,o,n))}remove(t){const e=this.objects.get(t);if(e){const s=this.hash(e.x,e.y,e.z),i=this.grid.get(s);i&&(i.delete(t),i.size===0&&this.grid.delete(s)),this.objects.delete(t)}}getNearby(t,e,s,i){let r,o,n,h;typeof t=="number"?(r=t,o=e,n=s,h=i):(r=t.x,o=t.y,n=t.z,h=e);const d=[],l=Math.ceil(h/this.cellSize),b=Math.floor(r/this.cellSize),y=Math.floor(o/this.cellSize),S=Math.floor(n/this.cellSize);for(let u=-l;u<=l;u++)for(let f=-l;f<=l;f++)for(let m=-l;m<=l;m++){const M=b+u,H=y+f,j=S+m,x=`${M},${H},${j}`,g=this.grid.get(x);g&&d.push(...Array.from(g))}return d}getNearbyWithDistance(t,e){const s=this.getNearby(t,e),i=[];for(const r of s){const o=this.objects.get(r);if(o){const n=t.distanceTo(o);n<=e&&i.push({id:r,distance:n,position:o.clone()})}}return i.sort((r,o)=>r.distance-o.distance)}update(t,e){this.insert(t,e)}clear(){this.grid.clear(),this.objects.clear()}getStats(){const t=this.objects.size,e=this.grid.size;let s=0;for(const r of this.grid.values())s=Math.max(s,r.size);const i=e>0?t/e:0;return{totalObjects:t,totalCells:e,averageObjectsPerCell:i,maxObjectsInCell:s}}getAllObjects(){const t=[];for(const[e,s]of this.objects.entries())t.push({id:e,position:s.clone()});return t}}class L{constructor(){a(this,"frameCount",0);a(this,"lastTime",performance.now());a(this,"fps",60);a(this,"fpsHistory",[]);a(this,"maxHistoryLength",60);a(this,"memoryInfo",{usedJSHeapSize:0,totalJSHeapSize:0,jsHeapSizeLimit:0});a(this,"LOW_FPS_THRESHOLD",45);a(this,"HIGH_FPS_THRESHOLD",55);a(this,"MEMORY_WARNING_THRESHOLD",.8)}update(){this.frameCount++;const t=performance.now(),e=t-this.lastTime;e>=1e3&&(this.fps=this.frameCount*1e3/e,this.fpsHistory.push(this.fps),this.fpsHistory.length>this.maxHistoryLength&&this.fpsHistory.shift(),this.frameCount=0,this.lastTime=t,this.updateMemoryInfo())}updateMemoryInfo(){if("memory"in performance){const t=performance.memory;this.memoryInfo={usedJSHeapSize:t.usedJSHeapSize,totalJSHeapSize:t.totalJSHeapSize,jsHeapSizeLimit:t.jsHeapSizeLimit}}}getFPS(){return Math.round(this.fps)}getAverageFPS(){if(this.fpsHistory.length===0)return this.fps;const t=this.fpsHistory.reduce((e,s)=>e+s,0);return Math.round(t/this.fpsHistory.length)}getMinFPS(){return this.fpsHistory.length===0?this.fps:Math.round(Math.min(...this.fpsHistory))}getMaxFPS(){return this.fpsHistory.length===0?this.fps:Math.round(Math.max(...this.fpsHistory))}getPerformanceLevel(){const t=this.getAverageFPS();return t<this.LOW_FPS_THRESHOLD?"low":t>this.HIGH_FPS_THRESHOLD?"high":"medium"}getMemoryUsage(){const t=n=>Math.round(n/1024/1024),e=t(this.memoryInfo.usedJSHeapSize),s=t(this.memoryInfo.totalJSHeapSize),i=t(this.memoryInfo.jsHeapSizeLimit),r=i>0?e/i:0,o=r>this.MEMORY_WARNING_THRESHOLD;return{used:e,total:s,limit:i,percentage:r,isWarning:o}}getStabilityScore(){if(this.fpsHistory.length<10)return 1;const t=this.getAverageFPS(),e=this.fpsHistory.reduce((r,o)=>r+Math.pow(o-t,2),0)/this.fpsHistory.length,s=Math.sqrt(e);return Math.max(0,1-s/10)}getRecommendations(){const t=[],e=this.getPerformanceLevel(),s=this.getMemoryUsage(),i=this.getStabilityScore();return e==="low"&&(t.push("Consider reducing particle count or 3D quality settings"),t.push("Check for memory leaks or excessive object creation")),s.isWarning&&(t.push("Memory usage is high - consider enabling object pooling"),t.push("Clear unused cached geometries or textures")),i<.7&&(t.push("Frame rate is unstable - check for blocking operations"),t.push("Consider using animation scheduler frame budgeting")),t.length===0&&t.push("Performance is optimal!"),t}getFullReport(){return{fps:{current:this.getFPS(),average:this.getAverageFPS(),min:this.getMinFPS(),max:this.getMaxFPS()},memory:this.getMemoryUsage(),performance:{level:this.getPerformanceLevel(),stability:this.getStabilityScore()},recommendations:this.getRecommendations()}}reset(){this.frameCount=0,this.lastTime=performance.now(),this.fps=60,this.fpsHistory=[]}}const B=new L;export{O as F,I as L,A as S,B as a,T as g};
//# sourceMappingURL=utils-DVgDaGdu.js.map
